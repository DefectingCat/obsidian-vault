# 3D 基础概念

## 场景与摄像机

一个场景中最少需要摄像机

![Untitled](3D%20%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5%209995c8ddd516409190699135421c9888/Untitled.png)

透视和正交两种。LayaAir引擎的3D摄像机默认是透视模式，这是一种模拟了人眼的视觉效果，近大远小。正交则没有透视感，常用于一些2D与3D混合的游戏或模型查看器等。

## 坐标系与坐标

LayaAir 3D 有两个坐标：位置坐标和UV坐标。

空间笛卡尔直角坐标系是用经过相同原点的xyz三条互相垂直的坐标轴相交而构成。

![Untitled](3D%20%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5%209995c8ddd516409190699135421c9888/Untitled%201.png)

坐标系的两个轴正方向一致的情况下，因第三轴正方向相反，所以将坐标系分为左手坐标系与右手坐标系。LayaAir等引擎采用的是右手坐标系。

![Untitled](3D%20%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5%209995c8ddd516409190699135421c9888/Untitled%202.png)

顶点可以理解为3D空间中的任意一个带xyz坐标的位置点，但顶点不仅包含了坐标位置信息，还有UV、法线、颜色等信息。

UV其实也是坐标， 完整的说应该是UVW（由于xyz已经被顶点坐标轴占用，所以另选三个字母表示）， 这三个轴U是屏幕水平方向，V是屏幕垂直方向，W的方向是垂直于显示器表面的，到目前为止，一般游戏开发是用不上的，所以我们通常就会简称为UV。

![Untitled](3D%20%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5%209995c8ddd516409190699135421c9888/Untitled%203.png)

## ****三角面、网格、模型****

三角形平面（简称三角面），三角面是由三个顶点构成，是显卡唯一能处理的基础多边形。由三个点构成的三角面一定是在同一个平面上，而四个或更多点构成的多边形在三维空间中，不一定会在同一个平面上。

网格（ Mesh）则是由一个三角面或多个三角面拼接形成，是构建模型形状的基础。

在LayaAir引擎中， 构成各种图形形状的三角面顶点数据以及三角面的索引数据集合就是网格，所以网格在游戏运行时是不可见的。

![Untitled](3D%20%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5%209995c8ddd516409190699135421c9888/Untitled%204.png)

模型是由网格（ Mesh）与材质（ Material）组成。

模型的基础是网格，网格的基础是三角面。三角面越多，模型可表现的细节越丰富。

![Untitled](3D%20%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5%209995c8ddd516409190699135421c9888/Untitled%205.png)

## 材质

LayaAir引擎支持的材质分类为模型材质、天空材质、拖尾材质、粒子材质。

![Untitled](3D%20%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5%209995c8ddd516409190699135421c9888/Untitled%206.png)

LayaAir引擎的模型材质还可以继续划分，分别为光照材质（BlinnPhongMaterial） 、不受光材质（UnlitMaterial）、特效材质（EffectMaterail）、PBR标准材质（PBRStandardMaterial） 、PBR高光材质(PBRSpecularMaterial) 、 水材质（WaterPrimaryMaterial）。

## ****纹理、贴图、面片****

贴图简单通俗的理解，就是将2D纹理贴到3D模型网格的过程。这个将3D顶点坐标与2D纹理的UV坐标映射对应的过程由引擎完成，开发者直接调用API，为材质设置对应的纹理即可。

之所以把面片放到纹理一起介绍，是因为对3D一知半解时，不少人会有一个误区，认为面片就是在3D空间中放了一个2D纹理位图。实际上，在三维空间中，哪怕只有一个三角形平面，也可以构成网格，可以设置材质，那这就是模型。所以面片，与其它多面体模型，本质上都是一样的。在下图中，我们在3D空间中看到的草地图片，其实是这个草地面片材质的贴图。

![Untitled](3D%20%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5%209995c8ddd516409190699135421c9888/Untitled%207.png)

## ****灯光、阴影、反射光****

3D中的光源就是灯光，其它如泛光、环境光等都是光效，而非光源。3D灯光有三种， 平行光（DirectionLight），点光（PointLight），聚光（SpotLight）

- 平行光是一种模拟大自然太阳光的灯光，光源来自无穷远的位置，来自光源的光线始终都是平行的且没有衰减。引擎中可设定光源方向，用于给全场景照亮。
    
    ![Untitled](3D%20%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5%209995c8ddd516409190699135421c9888/Untitled%208.png)
    
- 点光是一种以光源点为中心，向四周呈发射状的光源，光源点位于3D空间中的某个位置。类似于现实中的蜡烛光、篝火、家用电灯等发光的方式，这种光拥有照射范围和衰减半径。光照范围之外的地方则处于无光的黑暗之中。
    
    ![Untitled](3D%20%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5%209995c8ddd516409190699135421c9888/Untitled%209.png)
    
- 聚光与点光类似，都属于位置光，也是位于3D空间的某个位置，也有照射范围和衰减半径，但是，与向四周发散的无方向点光不同，聚光则拥有光源方向，是一种呈锥形角度的光源，类似于现实中的手电洞、舞台聚光灯等光源效果。
    
    ![Untitled](3D%20%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5%209995c8ddd516409190699135421c9888/Untitled%2010.png)
    

反射光，是指光源在照射到3D模型上，反射产生的光效。为了模拟自然反射现象，根据不同材质，引擎对反射光会使用不同的光照模型。

![Untitled](3D%20%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5%209995c8ddd516409190699135421c9888/Untitled%2011.png)

## ****加色法光效 、环境光、泛光、光照贴图****

光效就是看起来比较像光的一种效果。

- 加色法光效可以让材质本身就会有发光的效果。
- 环境光类似于全局颜色滤镜。
- 泛光在LayaAir引擎中属于后期效果。即便没有光源的照射，也可以产生一种类似光晕叠加的效果。
- 光照贴图是一种通过贴图的方式模拟游戏场景中的光影效果，也是游戏中为了节省性能而常用的一种伪光照视觉效果的制作方式。

## ****Shader（着色器）****

Shader 中文名为着色器， shader本质上是一段采用GLSL着色语言编写（着色语言好几种，基于webGL只能用GLSL语言）在GPU上运行的程序 ， 用于告诉图形软件如何计算和输出图像。

Shader主要分两类：顶点着色器和片段着色器（也叫片元着色器） 。

- 顶点着色器是用来处理顶点数据的程序，如顶点坐标、法线、颜色和纹理坐标。 它在每个顶点上调用，可将几何图形（例如：三角形）从一个位置转换为另一个位置， 例如，用于顶点变换、纹理坐标生成、 纹理坐标变换等等。
- 片段着色器用来计算和填充每个像素的颜色，所以也称为像素着色器。可用于插值的运算、 纹理存取、纹理应用 、 雾 、 色彩计算等。

## ****天空、粒子、拖尾****

LayaAir模拟的3D天空，提供了两种现成的网格，一种是立方体网格，这种天空称为天空盒( SkyBox)。另一种是球形网格( SkyDome )

天空盒：基于立方体网格的天空， 以6张无缝连接的材质纹理贴图形成。

![Untitled](3D%20%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5%209995c8ddd516409190699135421c9888/Untitled%2012.png)

球形网格的天空则采用1张纹理贴图形成，该技术方案相较于天空盒，可以制作出完全相同的视觉效果，但球形网格的顶点要多于天空盒，性能的消耗自然要大一些。如果只有一张贴图纹理的可以采用天空球的技术方案，否则建议采用天空盒方案。

另外，两种3D天空技术方案的使用差别也与材质有关，LayaAir引擎中自带了一个对应天空盒网格的天空盒材质（SkyBoxMaterial）、而天空球要么使用不需要贴图的程序化天空材质（SkyProceduralMaterial），要么就使用模型材质，因为天空不受光照影响，最好使用不受光材质。

粒子是一组分散的微小物体集合，通过让这些微小的物体按某种算法运动起来，从而实现诸如火焰、烟、爆炸、流水、等比较灵动的效果。粒子系统并不是一种绘制形式，而是一种动画方法，粒子系统的作用是在粒子产生、运动、变化以及消失这个生命周期内去控制它们。LayaAir引擎的粒子系统包括了粒子发射器、粒子动画器、和粒子渲染器等多个部分。

## ****3D物理系统、3D动画系统****

3D物理系统是通过模拟真实物理属性的方式来计算重力、运动、旋转、碰撞反馈等。

- 刚体动画又称为变换动画，是指不改变模型顶点、材质的基础上，只对模型进行旋转、缩放、位移的动画，比如，脚底光环、刀光等。刚体动画也经常与材质动画结合使用。
- 骨骼动画也称为蒙皮动画，这种动画主要是以改变模型顶点的方式产生动画。
- 摄像机动画是指通过改变摄像机位置而产生的动画效果。

## ****3D基础的常用数学概念****

### **1、向量**

既有大小又有方向的量称之为向量（物理学叫矢量），向量也有维度，例如，2维、3维、4维。与向量对应的是数量（物理学叫标量），数量是只有大小没有方向的量。 有的文章把数量理解为1维向量，而我们通常所指的向量是2维或以上维度，不包括1维。

在LayaAir引擎中，针对2维、3维、4维向量的封装方法示例分别为： Vector2(1, 2) 、Vector3(1, 1, 3)、Vector4(1, 2, 3, 0.5) 。然而LayaAir引擎封装的Vector方法，不仅可以作为向量的使用，还可以用于顶点坐标位置，或者表达颜色的时候使用。比如原点坐标Vector3(0, 0, 0)，颜色值Vector3 (0.6, 0.6, 0.6) 、Vector4(0.9, 0.5, 0.1, 1)。

提到向量，再顺带理解一下分量，我们把一个向量分解成几个方向的向量之和，那这些分解的向量就叫做该向量的分量（也称为向量投影）。 例如，某个向量坐标u为（5，10），那分解的向量坐标w1（5，0）和w2（0，10）都是向量坐标u的分量。在引擎中，我们也可以把向量元素视为分量，比如 Vector3( 0.6, 0.6, 0.5) ，有3个分量，其中的0.5称为这个向量的第3个分量。

### **2、 矩阵**

在线性代数中，矩阵是以行和列形式组织的矩形数字块。如果把向量定义为1维数组，那么矩阵就是2维数组。这里不要把2维理解为2D，是指来自数组的行与列形成2维。以数组的角度去理解，那向量是数量的数组，矩阵则是向量的数组。

矩阵是在显卡图形API中直接用于描述方位的形式，可立即进行向量的旋转。LayaAir引擎提供了3×3的旋转矩阵Matrix3x3() 和4×4的变换矩阵Matrix4x4()，变换矩阵可用于平移、旋转、缩放计算。

### **3、欧拉角、四元数**

欧拉角与四元数都是用于旋转计算的数学方法，刚刚介绍的矩阵明明也可以用于旋转计算，为什么要介绍这两种呢？相对而言，3×3旋转矩阵需要9个数，欧拉角只需3个数（3维向量），四元数只需要4个数（4维向量），明显轻量了很多。那是不是欧拉角最优，也不尽然。尽管欧拉角内存占用小，也更加易用，但欧拉角也有他特有的问题，那就是可能会导致万向节死锁。而四元数则相对于矩阵内存占用小，也不受万向节死锁的困扰，而且在平滑插值方面只能是四元数才能完成。

### **4、射线**

射线是只有一个端点无限延长形成的直的线，在LayaAir引擎中的射线 Ray是一个数据对象，拥有起点与发射方向两个属性。常用于基础的碰撞检测，也可以用于鼠标拾取。

### **5、包围体**

包围体用于可见检测计算，基本思想是体积稍大且结构简单的包围体来替代结构复杂的被包围体，当进行检测的时候，达到提高检测效率的作用。比如，一旦检测到包围体被遮挡不可见，那无论包围体内是什么样的模型，那全部不可见。LayaAir引擎中提供了盒状包围体（ 包围盒 ）与球状包围体（包围球）。